<?php
session_start();

// تضمين الملفات المطلوبة
require_once '../includes/init.php';
require_once '../includes/functions.php';

// التأكد من تسجيل الدخول
if (!isset($_SESSION['customer_id'])) {
    header('Location: /marketplace/customer/login.php');
    exit();
}

// الحصول على معايير البحث
$search = isset($_GET['search']) ? trim($_GET['search']) : '';
$category_id = isset($_GET['category']) ? (int)$_GET['category'] : '';
$current_location = isset($_SESSION['current_location']) ? $_SESSION['current_location'] : '';
$view_type = isset($_GET['view']) ? $_GET['view'] : 'products';

// جلب التصنيفات
$categories_sql = "SELECT * FROM categories ORDER BY name";
$categories_result = $conn->query($categories_sql);

// استعلام المنتجات
$products_sql = "SELECT p.*, s.name as store_name, c.name as category_name
                 FROM products p
                 INNER JOIN stores s ON p.store_id = s.id
                 LEFT JOIN categories c ON p.category_id = c.id
                 WHERE p.status = 'active' AND s.status = 'active'";

// إضافة شروط البحث إذا وجدت
if (isset($_GET['search']) && !empty($_GET['search'])) {
    $search_term = '%' . $_GET['search'] . '%';
    $products_sql .= " AND (p.name LIKE ? OR s.name LIKE ? OR c.name LIKE ?)";
}

// إضافة شروط التصنيف إذا وجدت
if (isset($_GET['category']) && !empty($_GET['category'])) {
    $products_sql .= " AND p.category_id = ?";
}

$products_sql .= " ORDER BY p.created_at DESC";

// تحضير وتنفيذ الاستعلام
$stmt = $conn->prepare($products_sql);

if ($stmt) {
    if (isset($_GET['search']) && !empty($_GET['search'])) {
        if (isset($_GET['category']) && !empty($_GET['category'])) {
            $stmt->bind_param("sssi", $search_term, $search_term, $search_term, $_GET['category']);
        } else {
            $stmt->bind_param("sss", $search_term, $search_term, $search_term);
        }
    } elseif (isset($_GET['category']) && !empty($_GET['category'])) {
        $stmt->bind_param("i", $_GET['category']);
    }

    $stmt->execute();
    $products_result = $stmt->get_result();
} else {
    $products_result = false;
}

// استعلام المتاجر مع معلومات إضافية
$stores_sql = "SELECT s.*, 
               COUNT(DISTINCT p.id) as product_count,
               AVG(r.rating) as avg_rating,
               COUNT(DISTINCT r.id) as rating_count,
               s.city as location
               FROM stores s
               LEFT JOIN products p ON s.id = p.store_id AND p.status = 'active'
               LEFT JOIN product_ratings r ON p.id = r.product_id
               WHERE s.status = 'active'";

// إضافة شروط البحث إذا وجدت
if (isset($_GET['search']) && !empty($_GET['search'])) {
    $search_term = '%' . $_GET['search'] . '%';
    $stores_sql .= " AND (s.name LIKE ? OR s.description LIKE ? OR s.city LIKE ?)";
}

// إضافة شروط التصنيف إذا وجدت
if (isset($_GET['category']) && !empty($_GET['category'])) {
    $stores_sql .= " AND EXISTS (SELECT 1 FROM products p2 WHERE p2.store_id = s.id AND p2.category_id = ?)";
}

$stores_sql .= " GROUP BY s.id ORDER BY s.created_at DESC";

// تحضير وتنفيذ الاستعلام
$stmt_stores = $conn->prepare($stores_sql);

if ($stmt_stores) {
    if (isset($_GET['search']) && !empty($_GET['search'])) {
        if (isset($_GET['category']) && !empty($_GET['category'])) {
            $stmt_stores->bind_param("sssi", $search_term, $search_term, $search_term, $_GET['category']);
        } else {
            $stmt_stores->bind_param("sss", $search_term, $search_term, $search_term);
        }
    } elseif (isset($_GET['category']) && !empty($_GET['category'])) {
        $stmt_stores->bind_param("i", $_GET['category']);
    }

    $stmt_stores->execute();
    $stores_result = $stmt_stores->get_result();
} else {
    $stores_result = false;
}
?>
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>السوق الإلكتروني - المنتجات والمتاجر</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap">
    <link rel="stylesheet" href="styles/marketplace-modern.css">
</head>
<body>
    <!-- هيدر الموقع بتصميم حديث -->
    <header class="market-header">
        <div class="container-fluid py-2">
            <div class="row align-items-center">
                <div class="col-md-2 col-sm-3 d-flex align-items-center">
                    <a href="index.php" class="market-logo me-3">
                        <i class="bi bi-shop"></i>
                        <div>
                            <span class="logo-text">السوق الإلكتروني</span>
                        </div>
                    </a>
                </div>
                <div class="col-md-6 col-sm-5">
                    <form action="" method="GET" class="search-form">
                        <div class="search-container">
                            <input type="text" name="search" class="search-input" 
                                placeholder="ابحث عن منتجات أو متاجر..." 
                                value="<?php echo htmlspecialchars($search); ?>">
                            <div class="dropdown">
                                <select name="view" id="searchType" class="search-select" onchange="toggleDropdown(this)">
                                    <option value="products" <?php echo ($view_type === 'products') ? 'selected' : ''; ?>>المنتجات</option>
                                    <option value="stores" <?php echo ($view_type === 'stores') ? 'selected' : ''; ?>>المتاجر</option>
                                </select>
                            </div>
                            <button type="submit" class="search-button">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                        <button type="button" class="shop-button" onclick="window.location.href='cart.php'">
                            <i class="bi bi-cart3 me-1"></i> تسوق
                        </button>
                        <input type="hidden" name="category" value="<?php echo $category_id; ?>">
                    </form>
                </div>
                <div class="col-md-4 col-sm-4 d-flex justify-content-end">
                    <div class="nav-links">
                        <a href="orders.php" class="nav-link">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-box me-1"></i>
                                <span>طلباتي</span>
                            </div>
                        </a>
                        <a href="wishlist.php" class="nav-link">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-heart me-1"></i>
                                <span>المفضلة</span>
                            </div>
                        </a>
                        <div class="user-dropdown">
                            <a href="#" class="nav-link" onclick="toggleUserMenu(event)">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-person-circle me-1"></i>
                                    <span><?php echo isset($_SESSION['customer_name']) ? htmlspecialchars($_SESSION['customer_name']) : 'حسابي'; ?></span>
                                    <i class="bi bi-chevron-down ms-1"></i>
                                </div>
                            </a>
                            <div class="user-dropdown-menu" id="userDropdownMenu">
                                <a class="user-dropdown-item" href="profile.php"><i class="bi bi-person me-2"></i> ملفي الشخصي</a>
                                <a class="user-dropdown-item" href="settings.php"><i class="bi bi-gear me-2"></i> الإعدادات</a>
                                <a class="user-dropdown-item" href="addresses.php"><i class="bi bi-geo-alt me-2"></i> عناويني</a>
                                <div class="user-dropdown-divider"></div>
                                <a class="user-dropdown-item" href="../logout.php"><i class="bi bi-box-arrow-right me-2"></i> تسجيل الخروج</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <nav class="market-nav">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex">
                        <div class="dropdown">
                            <a href="#" class="nav-link me-3" onclick="toggleCategoriesMenu(event)">
                                <i class="bi bi-list me-1"></i> جميع الفئات <i class="bi bi-chevron-down"></i>
                            </a>
                            <div class="dropdown-menu" id="categoriesDropdown">
                                <?php 
                                if ($categories_result) {
                                    $categories_result->data_seek(0);
                                    while ($category = $categories_result->fetch_assoc()): 
                                ?>
                                    <a class="dropdown-item" href="index.php?category=<?php echo $category['id']; ?>&view=products">
                                        <?php echo htmlspecialchars($category['name']); ?>
                                    </a>
                                <?php 
                                    endwhile; 
                                }
                                ?>
                            </div>
                        </div>
                        <a href="index.php?view=products" class="nav-link me-3 <?php echo ($view_type === 'products') ? 'active' : ''; ?>">المنتجات</a>
                        <a href="index.php?view=stores" class="nav-link me-3 <?php echo ($view_type === 'stores') ? 'active' : ''; ?>">المتاجر</a>
                        <a href="#" class="nav-link me-3">العروض اليومية</a>
                        <a href="most-liked.php" class="nav-link me-3">الأكثر إعجاباً</a>
                        <a href="top-rated.php" class="nav-link me-3">الأعلى تقييماً</a>
                        <a href="best-selling.php" class="nav-link">الأكثر مبيعاً</a>
                    </div>
                    <div class="location-button">
                        <a href="#" class="nav-link" onclick="getLocation()">
                            <i class="bi bi-geo-alt me-1"></i> تسوق حسب موقعك
                        </a>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- قسم الفئات المميزة أسفل الهيدر -->
    <section class="featured-categories">
        <div class="container">
            <!-- تم إزالة العنوان بناءً على طلب المستخدم -->
            <div class="category-blocks">
                <?php
                // استعلام لجلب الفئات مع عدد المنتجات في كل فئة
                $featured_categories_sql = "SELECT c.id, c.name, c.icon, COUNT(p.id) as product_count 
                                         FROM categories c 
                                         LEFT JOIN products p ON c.id = p.category_id AND p.status = 'active' 
                                         GROUP BY c.id 
                                         ORDER BY product_count DESC 
                                         LIMIT 10";
                $featured_categories_result = $conn->query($featured_categories_sql);
                
                if ($featured_categories_result && $featured_categories_result->num_rows > 0) {
                    while ($category = $featured_categories_result->fetch_assoc()) {
                        // تحديد الأيقونة المناسبة
                        $icon = !empty($category['icon']) ? $category['icon'] : 'bi-tag';
                        ?>
                        <div class="category-block">
                            <a href="index.php?category=<?php echo $category['id']; ?>">
                                <div class="category-icon">
                                    <i class="bi <?php echo $icon; ?>"></i>
                                </div>
                                <h3 class="category-name"><?php echo htmlspecialchars($category['name']); ?></h3>
                                <span class="category-count"><?php echo $category['product_count']; ?> منتج</span>
                            </a>
                        </div>
                        <?php
                    }
                } else {
                    // إذا لم تكن هناك فئات، عرض فئات افتراضية
                    $default_categories = [
                        ['name' => 'الإلكترونيات', 'icon' => 'bi-laptop', 'count' => '120'],
                        ['name' => 'الملابس', 'icon' => 'bi-bag', 'count' => '85'],
                        ['name' => 'الأثاث المنزلي', 'icon' => 'bi-house', 'count' => '64'],
                        ['name' => 'الجمال والعناية', 'icon' => 'bi-gem', 'count' => '42'],
                        ['name' => 'الكتب', 'icon' => 'bi-book', 'count' => '38']
                    ];
                    
                    foreach ($default_categories as $category) {
                        ?>
                        <div class="category-block">
                            <a href="#">
                                <div class="category-icon">
                                    <i class="bi <?php echo $category['icon']; ?>"></i>
                                </div>
                                <h3 class="category-name"><?php echo $category['name']; ?></h3>
                                <span class="category-count"><?php echo $category['count']; ?> منتج</span>
                            </a>
                        </div>
                        <?php
                    }
                }
                ?>
            </div>
            <div class="featured-controls">
                <button class="control-btn" id="prev-category"><i class="bi bi-chevron-right"></i></button>
                <button class="control-btn" id="next-category"><i class="bi bi-chevron-left"></i></button>
                <a href="categories.php" class="view-all-btn">عرض جميع الفئات</a>
            </div>
        </div>
    </section>

    
    <!-- قسم العروض الخاصة بالموقع -->
    <section class="site-offers mb-5">
        <div class="container">
            <div class="section-title mb-4">
                <h2>عروض حصرية</h2>
                <a href="all-offers.php" class="view-all">عرض الكل</a>
            </div>
            
            <div class="site-offers-slider">
                <div class="row">
                    <div class="col-md-8 mb-4">
                        <!-- العرض الرئيسي -->
                        <div class="main-offer">
                            <a href="offer.php?id=1">
                                <!-- صورة العرض الرئيسي مع صورة افتراضية محسنة -->
                                <div class="offer-image-container main-offer-image" style="background: linear-gradient(135deg, #e74c3c, #f1c40f); height: 350px; border-radius: 10px; position: relative; overflow: hidden;">
                                    <div class="offer-overlay" style="position: absolute; bottom: 0; left: 0; right: 0; padding: 30px 20px; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); color: white; text-align: start;">
                                        <h3 style="font-size: 28px; font-weight: 700; margin-bottom: 10px;">عروض نهاية الأسبوع</h3>
                                        <p style="font-size: 16px; margin-bottom: 0;">خصومات تصل إلى 50% على جميع المنتجات</p>
                                    </div>
                                </div>
                            </a>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="row">
                            <!-- عرض ثانوي 1 - منتجات جديدة -->
                            <div class="col-12 mb-4">
                                <div class="secondary-offer">
                                    <a href="offer.php?id=2">
                                        <!-- صورة العرض الثانوي الأول مع صورة افتراضية محسنة -->
                                        <div class="offer-image-container" style="background: linear-gradient(135deg, #2ecc71, #1abc9c); height: 165px; border-radius: 10px; position: relative; overflow: hidden;">
                                            <div class="offer-overlay" style="position: absolute; bottom: 0; left: 0; right: 0; padding: 15px; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); color: white; text-align: start;">
                                                <h4 style="font-size: 20px; font-weight: 600; margin-bottom: 5px;">منتجات جديدة</h4>
                                                <p style="font-size: 14px; margin-bottom: 0;">اكتشف أحدث المنتجات</p>
                                            </div>
                                        </div>
                                    </a>
                                </div>
                            </div>
                            <!-- عرض ثانوي 2 - توصيل مجاني -->
                            <div class="col-12">
                                <div class="secondary-offer">
                                    <a href="offer.php?id=3">
                                        <!-- صورة العرض الثانوي الثاني مع صورة افتراضية محسنة -->
                                        <div class="offer-image-container" style="background: linear-gradient(135deg, #9b59b6, #8e44ad); height: 165px; border-radius: 10px; position: relative; overflow: hidden;">
                                            <div class="offer-overlay" style="position: absolute; bottom: 0; left: 0; right: 0; padding: 15px; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); color: white; text-align: start;">
                                                <h4 style="font-size: 20px; font-weight: 600; margin-bottom: 5px;">توصيل مجاني</h4>
                                                <p style="font-size: 14px; margin-bottom: 0;">للطلبات أكثر من 200 ريال</p>
                                            </div>
                                        </div>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div class="container">
        <?php if ($view_type === 'products'): ?>
            <!-- عرض المنتجات -->
            <div class="section-title mb-4">
                <h2>المنتجات <?php echo !empty($search) ? 'المطابقة لـ "'.htmlspecialchars($search).'"' : ''; ?></h2>
                <span><?php echo ($products_result) ? $products_result->num_rows : 0; ?> منتج</span>
            </div>

            <?php if ($products_result && $products_result->num_rows > 0): ?>
                <div class="products-section">
                    <div class="section-header d-flex justify-content-between align-items-center mb-4">
                        <h2 class="section-title">المنتجات المتوفرة</h2>
                        <div class="view-options">
                            <button class="btn btn-sm btn-outline-secondary me-2" id="grid-view"><i class="bi bi-grid"></i></button>
                            <button class="btn btn-sm btn-outline-secondary" id="list-view"><i class="bi bi-list"></i></button>
                        </div>
                    </div>
                    <div class="row row-cols-1 row-cols-md-4 g-4">
                    <?php while ($product = $products_result->fetch_assoc()): ?>
                        <div class="col">
                            <div class="card h-100">
                                <?php if (!empty($product['image_url'])): ?>
                                    <!-- حاوية الصورة مع الكاروسيل -->
                                    <div class="product-card-image">
                                        <!-- معرف للصورة -->
                                        <a href="product-details.php?id=<?php echo $product['id']; ?>" class="d-block">
                                            <div id="productCarousel-<?php echo $product['id']; ?>" class="carousel slide" data-bs-ride="false">
                                                <div class="carousel-inner">
                                                    <!-- الصورة الرئيسية -->
                                                    <div class="carousel-item active">
                                                        <?php
                                                        $image_path = '';
                                                        if (strpos($product['image_url'], 'http') === 0) {
                                                            $image_path = $product['image_url'];
                                                        } else if (file_exists('../uploads/products/' . basename($product['image_url']))) {
                                                            $image_path = '../uploads/products/' . basename($product['image_url']);
                                                        } else if (file_exists('../' . $product['image_url'])) {
                                                            $image_path = '../' . $product['image_url'];
                                                        } else {
                                                            $image_path = 'assets/images/product-placeholder.jpg';
                                                        }
                                                        ?>
                                                        <img src="<?php echo htmlspecialchars($image_path); ?>" 
                                                             class="product-image" alt="<?php echo htmlspecialchars($product['name']); ?>">
                                                    </div>
                                                    <!-- صورة افتراضية إضافية للعرض -->
                                                    <?php if (!empty($product['additional_images'])): ?>
                                                        <?php 
                                                        $additional_images = explode(',', $product['additional_images']);
                                                        foreach ($additional_images as $img): 
                                                            if (!empty($img)):
                                                                $add_img_path = '';
                                                                if (file_exists('../' . trim($img))) {
                                                                    $add_img_path = '../' . trim($img);
                                                                } else {
                                                                    continue;
                                                                }
                                                        ?>
                                                        <div class="carousel-item">
                                                            <img src="<?php echo htmlspecialchars($add_img_path); ?>" 
                                                                 class="product-image" alt="<?php echo htmlspecialchars($product['name']); ?>">
                                                        </div>
                                                        <?php 
                                                            endif;
                                                        endforeach; 
                                                        ?>
                                                    <?php endif; ?>
                                                </div>
                                            
                                                <!-- أزرار التنقل -->
                                                <!-- زر السابق (اليسار) -->
                                                <button class="carousel-control-prev" type="button" 
                                                        data-bs-target="#productCarousel-<?php echo $product['id']; ?>" data-bs-slide="prev"
                                                        onclick="event.stopPropagation()">
                                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                                    <span class="visually-hidden">السابق</span>
                                                </button>
                                                <!-- زر التالي (اليمين) -->
                                                <button class="carousel-control-next" type="button" 
                                                        data-bs-target="#productCarousel-<?php echo $product['id']; ?>" data-bs-slide="next"
                                                        onclick="event.stopPropagation()">
                                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                                    <span class="visually-hidden">التالي</span>
                                                </button>
                                            </div>
                                        </a>
                                    </div>
                                <?php else: ?>
                                            if (isset($product['created_at']) && (time() - strtotime($product['created_at']) < 7 * 24 * 60 * 60)) {
                                                echo '<div class="new-badge">جديد</div>';
                                            }
                                        }
                                        
                                        echo '</a>';
                                        echo '</div>'; // إغلاق product-card-image
                                        ?>
                                </div>
                                
                                <!-- معلومات المنتج -->
                                <div class="card-body p-3">
                                    <h3 class="product-title">
                                        <a href="product-details.php?id=<?php echo $product['id']; ?>">
                                            <?php echo htmlspecialchars($product['name']); ?>
                                        </a>
                                    </h3>
                                    
                                    <?php if (!empty($product['description'])): ?>
                                    <div class="product-description">
                                        <?php echo mb_substr(htmlspecialchars($product['description']), 0, 60) . '...'; ?>
                                    </div>
                                    <?php endif; ?>
                                    
                                    <div class="product-price mt-2">
                                        <?php if (isset($product['price']) && isset($product['final_price']) && $product['final_price'] < $product['price']): ?>
                                            <span class="original-price"><?php echo number_format($product['price'], 2); ?></span>
                                        <?php endif; ?>
                                        <span class="current-price"><?php echo number_format(isset($product['final_price']) ? $product['final_price'] : $product['price'], 2); ?> ر.س</span>
                                    </div>
                                    
                                    <div class="product-rating">
                                        <div class="stars">
                                            <?php 
                                            $rating = isset($product['avg_rating']) ? floatval($product['avg_rating']) : 0;
                                            for ($i = 1; $i <= 5; $i++) {
                                                if ($i <= $rating) {
                                                    echo '<i class="bi bi-star-fill"></i>';
                                                } elseif ($i - 0.5 <= $rating) {
                                                    echo '<i class="bi bi-star-half"></i>';
                                                } else {
                                                    echo '<i class="bi bi-star"></i>';
                                                }
                                            }
                                            ?>
                                        </div>
                                        <span class="rating-value"><?php echo number_format($rating, 1); ?></span>
                                        <span class="rating-count">(<?php echo isset($product['rating_count']) ? intval($product['rating_count']) : '0'; ?>)</span>
                                    </div>
                                    
                                    <div class="store-info">
                                        <span class="store-name"><?php echo htmlspecialchars($product['store_name']); ?></span>
                                    </div>
                                    
                                    <div class="product-actions d-flex justify-content-between align-items-center mt-3">
                                        <div class="d-flex">
                                            <a href="add-to-cart.php?id=<?php echo $product['id']; ?>" class="btn btn-primary btn-sm me-2">
                                                <i class="bi bi-cart-plus"></i> أضف
                                            </a>
                                            <a href="product-details.php?id=<?php echo $product['id']; ?>" class="btn btn-outline-secondary btn-sm">
                                                <i class="bi bi-eye"></i> التفاصيل
                                            </a>
                                        </div>
                                        <div class="product-likes">
                                            <button class="like-btn" data-product-id="<?php echo $product['id']; ?>">
                                                <i class="bi bi-heart<?php echo (isset($product['is_liked']) && $product['is_liked']) ? '-fill text-danger' : ''; ?>"></i>
                                            </button>
                                            <span class="likes-count"><?php echo isset($product['likes_count']) ? $product['likes_count'] : '0'; ?></span>
                                            <span>إعجاب</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <?php endwhile; ?>
                </div>
            <?php else: ?>
                <div class="alert alert-custom">
                    <i class="bi bi-info-circle me-2"></i>
                    لا توجد منتجات متاحة حالياً.
                </div>
            <?php endif; ?>
        <?php else: ?>
            <!-- عرض المتاجر -->
            <div class="section-title mb-4">
                <h2>المتاجر <?php echo !empty($search) ? 'المطابقة لـ "'.htmlspecialchars($search).'"' : ''; ?></h2>
                <span><?php echo ($stores_result) ? $stores_result->num_rows : 0; ?> متجر</span>
            </div>

            <?php if ($stores_result && $stores_result->num_rows > 0): ?>
                <div class="store-grid">
                    <?php while ($store = $stores_result->fetch_assoc()): ?>
                        <div class="store-card">
                            <!-- شارة المتجر -->
                            <?php if (isset($store['created_at']) && strtotime($store['created_at']) > strtotime('-30 days')): ?>
                                <div class="store-badge new">متجر جديد</div>
                            <?php endif; ?>
                            
                            <!-- صورة المتجر -->
                            <a href="store-page.php?id=<?php echo $store['id']; ?>" class="store-image-container">
                                <?php if (!empty($store['logo'])): ?>
                                    <img src="../uploads/stores/<?php echo htmlspecialchars($store['logo']); ?>" 
                                         class="store-image" alt="<?php echo htmlspecialchars($store['name']); ?>">
                                <?php elseif (!empty($store['logo_url'])): ?>
                                    <img src="../<?php echo htmlspecialchars($store['logo_url']); ?>" 
                                         class="store-image" alt="<?php echo htmlspecialchars($store['name']); ?>">
                                <?php else: ?>
                                    <div class="store-no-image">
                                        <i class="bi bi-shop"></i>
                                    </div>
                                <?php endif; ?>
                            </a>
                            
                            <div class="store-info">
                                <!-- اسم المتجر -->
                                <h3 class="store-title">
                                    <a href="store-page.php?id=<?php echo $store['id']; ?>">
                                        <?php echo htmlspecialchars($store['name']); ?>
                                    </a>
                                </h3>
                                
                                <!-- وصف المتجر -->
                                <?php if (!empty($store['description'])): ?>
                                    <p class="store-description">
                                        <?php echo mb_substr(htmlspecialchars($store['description']), 0, 100); ?>...
                                    </p>
                                <?php endif; ?>
                                
                                <!-- معلومات المتجر -->
                                <div class="store-meta">
                                    <?php if (isset($store['product_count'])): ?>
                                    <div class="store-meta-item">
                                        <i class="bi bi-box-seam"></i>
                                        <span><?php echo $store['product_count']; ?> منتج</span>
                                    </div>
                                    <?php endif; ?>
                                    
                                    <?php if (isset($store['avg_rating'])): ?>
                                    <div class="store-meta-item">
                                        <i class="bi bi-star-fill"></i>
                                        <span><?php echo number_format($store['avg_rating'], 1); ?></span>
                                    </div>
                                    <?php endif; ?>
                                    
                                    <?php if (isset($store['location'])): ?>
                                    <div class="store-meta-item">
                                        <i class="bi bi-geo-alt"></i>
                                        <span><?php echo htmlspecialchars($store['location']); ?></span>
                                    </div>
                                    <?php endif; ?>
                                </div>
                                
                                <!-- أزرار الإجراءات -->
                                <div class="store-actions mt-3">
                                    <a href="store-page.php?id=<?php echo $store['id']; ?>" class="btn btn-primary w-100">
                                        زيارة المتجر
                                    </a>
                                </div>
                            </div>
                        </div>
                    <?php endwhile; ?>
                </div>
            <?php else: ?>
                <div class="alert alert-info text-center">
                    لا توجد متاجر متاحة حالياً
                </div>
            <?php endif; ?>
        <?php endif; ?>
    </div>

    <!-- نافذة العرض السريع -->
    <div class="modal fade" id="quickViewModal" tabindex="-1" aria-labelledby="quickViewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="quickViewModalLabel">عرض سريع للمنتج</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="quick-view-image">
                                <img src="" id="quickViewImage" class="img-fluid" alt="صورة المنتج">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h3 id="quickViewName" class="mb-3"></h3>
                            <div class="quick-view-price mb-3">
                                <span id="quickViewPrice"></span> ريال
                            </div>
                            <div class="quick-view-description mb-3" id="quickViewDescription"></div>
                            <div class="quick-view-actions">
                                <a href="#" id="quickViewDetailsLink" class="btn btn-primary me-2">عرض التفاصيل</a>
                                <a href="#" id="quickViewStoreLink" class="btn btn-outline-secondary">زيارة المتجر</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- سكريبت العرض السريع والإعجاب -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // وظائف القوائم المنسدلة
    function toggleUserMenu(event) {
        event.preventDefault();
        const menu = document.getElementById('userDropdownMenu');
        menu.classList.toggle('show');
    }
    
    function toggleCategoriesMenu(event) {
        event.preventDefault();
        const menu = document.getElementById('categoriesDropdown');
        menu.classList.toggle('show');
    }
    
    function toggleDropdown(selectElement) {
        // يمكن إضافة منطق إضافي هنا إذا لزم الأمر
    }
    
    // إغلاق القوائم المنسدلة عند النقر في أي مكان آخر
    document.addEventListener('click', function(event) {
        const userDropdown = document.querySelector('.user-dropdown');
        const categoriesDropdown = document.querySelector('.dropdown');
        
        if (userDropdown && !userDropdown.contains(event.target)) {
            document.getElementById('userDropdownMenu').classList.remove('show');
        }
        
        if (categoriesDropdown && !categoriesDropdown.contains(event.target)) {
            document.getElementById('categoriesDropdown').classList.remove('show');
        }
    });
    
    document.addEventListener('DOMContentLoaded', function() {
        // التحكم في عرض الفئات
        const prevCategoryBtn = document.getElementById('prev-category');
        const nextCategoryBtn = document.getElementById('next-category');
        const categoryBlocks = document.querySelector('.category-blocks');
        
        if (prevCategoryBtn && nextCategoryBtn && categoryBlocks) {
            // تحديد عدد العناصر المرئية حسب حجم الشاشة
            const getVisibleItems = () => {
                if (window.innerWidth < 576) return 1;
                if (window.innerWidth < 768) return 2;
                if (window.innerWidth < 992) return 3;
                return 5;
            };
            
            let currentPosition = 0;
            const items = categoryBlocks.querySelectorAll('.category-block');
            const totalItems = items.length;
            
            const updateCategoryPosition = () => {
                const visibleItems = getVisibleItems();
                const itemWidth = items[0].offsetWidth;
                const gap = 20; // الفجوة بين العناصر
                const maxPosition = Math.max(0, totalItems - visibleItems);
                
                // التأكد من أن الموضع الحالي ضمن الحدود المسموح بها
                currentPosition = Math.max(0, Math.min(currentPosition, maxPosition));
                
                // تحديث موضع العناصر
                const translateX = currentPosition * (itemWidth + gap);
                categoryBlocks.style.transform = `translateX(${translateX}px)`;
                
                // تحديث حالة الأزرار
                prevCategoryBtn.disabled = currentPosition === 0;
                nextCategoryBtn.disabled = currentPosition >= maxPosition;
                
                // تغيير لون الأزرار حسب الحالة
                prevCategoryBtn.style.opacity = currentPosition === 0 ? '0.5' : '1';
                nextCategoryBtn.style.opacity = currentPosition >= maxPosition ? '0.5' : '1';
            };
            
            // إضافة أنماط CSS للتحريك السلس
            categoryBlocks.style.display = 'flex';
            categoryBlocks.style.transition = 'transform 0.3s ease';
            categoryBlocks.style.flexWrap = 'nowrap';
            
            // تعيين عرض ثابت للعناصر
            items.forEach(item => {
                item.style.flex = '0 0 auto';
                item.style.width = `calc(${100 / getVisibleItems()}% - ${20 * (getVisibleItems() - 1) / getVisibleItems()}px)`;
            });
            
            // إضافة مستمعي الأحداث للأزرار
            prevCategoryBtn.addEventListener('click', () => {
                currentPosition--;
                updateCategoryPosition();
            });
            
            nextCategoryBtn.addEventListener('click', () => {
                currentPosition++;
                updateCategoryPosition();
            });
            
            // تحديث الموضع عند تغيير حجم النافذة
            window.addEventListener('resize', () => {
                items.forEach(item => {
                    item.style.width = `calc(${100 / getVisibleItems()}% - ${20 * (getVisibleItems() - 1) / getVisibleItems()}px)`;
                });
                updateCategoryPosition();
            });
            
            // تعيين الحالة الأولية
            updateCategoryPosition();
        }
        
        // معالجة العرض السريع
        const quickViewModal = document.getElementById('quickViewModal');
        if (quickViewModal) {
            quickViewModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const productId = button.getAttribute('data-product-id');
                const productName = button.getAttribute('data-product-name');
                const productPrice = button.getAttribute('data-product-price');
                const productImage = button.getAttribute('data-product-image');
                
                document.getElementById('quickViewName').textContent = productName;
                document.getElementById('quickViewPrice').textContent = productPrice;
                
                if (productImage) {
                    document.getElementById('quickViewImage').src = productImage;
                    document.getElementById('quickViewImage').style.display = 'block';
                } else {
                    document.getElementById('quickViewImage').style.display = 'none';
                }
                
                document.getElementById('quickViewDetailsLink').href = 'product-details.php?id=' + productId;
                
                // الحصول على معلومات إضافية عن المنتج باستخدام AJAX
                fetch('get_product_info.php?id=' + productId)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('quickViewDescription').textContent = data.description || 'لا يوجد وصف متاح';
                            document.getElementById('quickViewStoreLink').href = 'store-page.php?id=' + data.store_id;
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching product info:', error);
                    });
            });
        }
        
        // معالجة زر الإعجاب
        const wishlistButtons = document.querySelectorAll('.wishlist-icon');
        wishlistButtons.forEach(button => {
            button.addEventListener('click', function() {
                const productId = this.getAttribute('data-product-id');
                
                fetch('handle_like.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'product_id=' + productId
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // تغيير شكل الزر بناءً على حالة الإعجاب
                        if (data.liked) {
                            this.innerHTML = '<i class="bi bi-heart-fill text-danger"></i>';
                        } else {
                            this.innerHTML = '<i class="bi bi-heart"></i>';
                        }
                    } else if (data.error === 'not_logged_in') {
                        // توجيه المستخدم لتسجيل الدخول
                        window.location.href = 'login.php?redirect=' + encodeURIComponent(window.location.href);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            });
        });
    });
    
    // دوال تقليب صور المنتجات
    function prevImage(productId) {
        const imagesContainer = document.getElementById('product-images-' + productId);
        if (!imagesContainer) return;
        
        let current = parseInt(imagesContainer.getAttribute('data-current'));
        const total = parseInt(imagesContainer.getAttribute('data-total'));
        
        current = (current - 1 + total) % total;
        imagesContainer.setAttribute('data-current', current);
        
        const imagePath = imagesContainer.children[current].getAttribute('data-src');
        const productCard = imagesContainer.closest('.product-card');
        const imageElement = productCard.querySelector('img');
        
        // تغيير الصورة مع تأثير انتقالي
        imageElement.style.opacity = '0.5';
        setTimeout(() => {
            imageElement.src = imagePath;
            imageElement.style.opacity = '1';
        }, 200);
        
        // منع انتشار الحدث
        event.preventDefault();
        event.stopPropagation();
    }
    
    function nextImage(productId) {
        const imagesContainer = document.getElementById('product-images-' + productId);
        if (!imagesContainer) return;
        
        let current = parseInt(imagesContainer.getAttribute('data-current'));
        const total = parseInt(imagesContainer.getAttribute('data-total'));
        
        current = (current + 1) % total;
        imagesContainer.setAttribute('data-current', current);
        
        const imagePath = imagesContainer.children[current].getAttribute('data-src');
        const productCard = imagesContainer.closest('.product-card');
        const imageElement = productCard.querySelector('img');
        
        // تغيير الصورة مع تأثير انتقالي
        imageElement.style.opacity = '0.5';
        setTimeout(() => {
            imageElement.src = imagePath;
            imageElement.style.opacity = '1';
        }, 200);
        
        // منع انتشار الحدث
        event.preventDefault();
        event.stopPropagation();
    }
    
    // الحصول على الموقع الجغرافي
    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                window.location.href = `index.php?lat=${lat}&lng=${lng}&view=<?php echo $view_type; ?>`;
            }, function(error) {
                alert('عذراً، لم نتمكن من تحديد موقعك. الرجاء المحاولة مرة أخرى.');
            });
        } else {
            alert('عذراً، متصفحك لا يدعم تحديد الموقع.');
        }
    }
    </script>

<?php include '../includes/customer_footer.php'; ?>
</body>
</html>
